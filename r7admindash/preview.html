<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Add these Firebase SDK imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getFirestore, collection, addDoc, setDoc, doc, query, where, getDocs, updateDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
        
        // Make Firebase functions globally available
        window.initializeApp = initializeApp;
        window.getDatabase = getDatabase;
        window.ref = ref;
        window.push = push;
        window.set = set;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.getStorage = getStorage;
        window.storageRef = storageRef;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
        window.runTransaction = runTransaction;
    </script>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="icons/t7logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Form</title>
    <style>
        :root {
            --primary-color: #ff0000;
            --secondary-color: #f0f4f8;
            --accent-color: #ffa500;
            --text-color: #333;
            --border-color: #000000;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--secondary-color);
        }

        .container {
            max-width: 2000px;
            margin: 0 auto;
            padding: 20px;
        }

        h2, h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.5rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        h2 {
            font-size: 1.8rem;
        }

        h3 {
            font-size: 1.4rem;
        }

        .form-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        input[type="email"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }

        select[disabled] {
            background-color: #f0f0f0;
            color: #666;
            cursor: not-allowed;
        }

        select[multiple] {
            height: auto;
        }

        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: #004a6e;
        }

        .btn-secondary {
            background-color: var(--accent-color);
        }

        .btn-secondary:hover {
            background-color: #e69500;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: var(--secondary-color);
            font-weight: bold;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            h3 {
                font-size: 1.2rem;
            }

            .form-container {
                padding: 15px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .btn {
                padding: 12px 18px;
                font-size: 16px;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            input[type="text"],
            input[type="date"],
            input[type="number"],
            input[type="email"],
            input[type="time"],
            select,
            textarea {
                font-size: 14px;
            }

            select[disabled] {
                background-color: #f0f0f0;
                color: #666;
                cursor: not-allowed;
            }

            label {
                font-size: 14px;
            }

            #photo-upload {
                width: 100%;
                padding: 10px;
            }
        }

        #page2 {
            display: none;
        }
        @media print {
            .grid {
                display: grid !important;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
            }

            body {
                background-color: white !important;
                color: black !important;
            }

            .btn {
                display: none;
            }

            #photo-upload {
                display: none;
            }
        }

        .fixed-container {
            width: 1750px;
            margin: 0 auto;
            overflow: hidden;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            transform: translateY(-50px);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }

        .modal.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        @media print {
    .grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
    }

    body {
        background-color: white !important;
        color: black !important;
    }

    .btn {
        display: none;
    }

    #photo-upload {
        display: none;
    }
}

#successModal .modal-content {
    transform: scale(0.7);
    transition: transform 0.3s ease-in-out;
}

#successModal.show .modal-content {
    transform: scale(1);
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #ff0000;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Mobile-specific styles */
@media screen and (max-width: 768px) {
    .fixed-container {
        width: 100%;
        padding: 10px;
    }

    .form-container {
        padding: 15px;
    }

    /* Header adjustments */
    header {
        flex-direction: column;
        align-items: center !important;
        text-align: center;
    }

    header h1 {
        font-size: 1.5rem !important;
        margin-top: 10px !important;
    }

    header h3 {
        font-size: 1rem !important;
    }

    /* ID Picture container adjustment */
    header div[style*="flex: 0 1 400px"] {
        width: 200px !important;
        height: 200px !important;
        margin: 20px auto !important;
    }

    /* Form elements adjustments */
    .grid {
        grid-template-columns: 1fr !important;
        gap: 10px;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="email"],
    input[type="time"],
    select,
    textarea {
        padding: 8px;
        font-size: 14px;
    }

    /* Table adjustments */
    table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }

    th, td {
        min-width: 120px;
        padding: 8px;
    }

    /* Button adjustments */
    .btn {
        width: 100%;
        margin-bottom: 10px;
        padding: 12px;
    }

    /* Modal adjustments */
    .modal-content {
        width: 95%;
        margin: 20px auto;
        padding: 15px;
    }
}

/* Tablet-specific adjustments */
@media screen and (min-width: 769px) and (max-width: 1024px) {
    .fixed-container {
        width: 100%;
        padding: 20px;
    }

    .grid {
        grid-template-columns: repeat(2, 1fr);
    }

    header div[style*="flex: 0 1 400px"] {
        width: 300px !important;
        height: 300px !important;
    }
}

/* Print styles - keep them unchanged */
@media print {
    .grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
    }

    body {
        background-color: white !important;
        color: black !important;
    }

    .btn {
        display: none;
    }

    #photo-upload {
        display: none;
    }
}

#importButton {
    position: relative;
    min-width: 200px;
}

#importButton:disabled {
    cursor: not-allowed;
    opacity: 0.7;
}

.spinner-border {
    margin-right: 8px;
}
    </style>
</head>
<body>
    <div class="fixed-container">
        <form id="tesdaForm">
            <div id="page1" class="form-container">
                <div class="form-section">
                    <header style="padding: 10px; display: flex; align-items: flex-start; justify-content: flex-start;">
                        <div style="display: flex; align-items: center;">
                            <img src="../icons/tlogo.png" alt="Logo" style="width: 100px; height: auto; margin-right: 20px;">
                            <div>
                                <h1 style="margin: 0; font-size: 2rem;">Technical Education and Skills Development Authority</h1>
                                <h3 style="margin: 0;">Pangasiwaan sa Edukasyong Teknikal at Pagpapaunlad ng Kasanayan</h3>
                            </div>
                        </div>
                        <div 
                        style="flex: 0 1 400px; height: 400px; background-color: #f0f4f8; border: 2px solid var(--border-color); margin-left: auto; margin-right: 20px; position: relative;">                   
                            <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #aaa; font-size: 1.2rem;">ID PICTURE (2"x 2" size)</span>
                        </div>
                        <!-- ... existing header code ... -->
                    </header>
                    <div style="text-align: center; margin-top: 10px;">
                        <hr style="border: 1px solid var(--border-color); width: 40%; margin: 0 auto;">
                        <span style="display: block; margin-top: 5px; font-size: 1rem;">Applicant's Signature</span>
                    </div> 
                    <h2>1. To be accomplished by TESDA</h2>
                    <div class="form-section">
                        <div class="grid">
                            <div class="form-group">
                                <label for="nmis-code">1.1. NMIS Manpower Code:</label>
                                <input type="text" id="nmis-code" name="nmis-code" required readonly>
                            </div>
                            <div class="form-group">
                                <label for="nmis-date">1.2. NMIS Entry Date:</label>
                                <input type="date" id="nmis-date" name="nmis-date" required readonly>
                            </div>
                        </div>
                    </div>
                </div>
            
                <div class="form-section">
                    <h2>2. Manpower Profile</h2>
                    <div class="grid">
                        <div class="form-group">
                            <label for="last-name">Last Name:</label>
                            <input type="text" id="last_name" name="last-name" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="first-name">First Name:</label>
                            <input type="text" id="first_name" name="first-name" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="middle-name">Middle Name:</label>
                            <input type="text" id="middle_initial" name="middle-name" readonly>
                        </div>
                        <div class="form-group">
                            <label for="extension">Extension:</label>
                            <input type="text" id="extension" name="extension" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="address">2.2. Mailing Address:</label>
                        <input type="text" id="address" name="address" required readonly>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label for="city">City:</label>
                            <input type="text" id="city" name="city" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="province">Province:</label>
                            <input type="text" id="province" name="province" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="region">Region:</label>
                            <input type="text" id="region" name="region" required readonly>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label for="zip-code">Zip Code:</label>
                            <input type="text" id="zip-code" name="zip-code" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="po-box">P.O. Box No.:</label>
                            <input type="text" id="po-box" name="po-box" readonly>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label for="sex">2.3. Sex:</label>
                            <input type="text" id="sex" name="sex" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="civil-status">2.4. Civil Status:</label>
                            <input type="text" id="civil-status" name="civil-status" required readonly>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label for="contact">2.5. Contact Number(s):</label>
                            <input type="text" id="contact" name="contact" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="telephone">Telephone:</label>
                            <input type="text" id="telephone" name="telephone" readonly>
                        </div>
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" name="email" readonly>
                        </div>
                        <div class="form-group">
                            <label for="fax">Fax:</label>
                            <input type="text" id="fax" name="fax" readonly>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label for="employment-type">2.6. Employment Type:</label>
                            <input type="text" id="employment-type" name="employment-type" value="<!-- Populate with selected value -->" readonly>
                        </div>
                        <div class="form-group">
                            <label for="employment-status">2.7. Employment Status:</label>
                            <input type="text" id="employment-status" name="employment-status" value="<!-- Populate with selected value -->" readonly>
                        </div>
                    </div>
                </div>
            
                <div class="form-section">
                    <h2>3. Personal Information</h2>
                    <div class="grid">
                        <div class="form-group">
                            <label for="birthdate">3.1. Birthdate:</label>
                            <input type="date" id="birthdate" name="birthdate" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="birthplace">3.2. Birth Place:</label>
                            <input type="text" id="birthplace" name="birthplace" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="citizenship">3.3. Citizenship:</label>
                            <input type="text" id="citizenship" name="citizenship" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="religion">3.4. Religion:</label>
                            <input type="text" id="religion" name="religion" readonly>
                        </div>
                        <div class="form-group">
                            <label for="height">3.5. Height:</label>
                            <input type="text" id="height" name="height" readonly>
                        </div>
                        <div class="form-group">
                            <label for="weight">3.6. Weight:</label>
                            <input type="text" id="weight" name="weight" readonly>
                        </div>
                        <div class="form-group">
                            <label for="blood-type">3.7. Blood Type:</label>
                            <input type="text" id="blood-type" name="blood-type" readonly>
                        </div>
                        <div class="form-group">
                            <label for="sss">3.8. SSS No.:</label>
                            <input type="text" id="sss" name="sss" readonly>
                        </div>
                        <div class="form-group">
                            <label for="gsis">3.9. GSIS No.:</label>
                            <input type="text" id="gsis" name="gsis" readonly>
                        </div>
                        <div class="form-group">
                            <label for="tin">3.10. TIN No.:</label>
                            <input type="text" id="tin" name="tin" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="distinguishing-marks">3.11. Distinguishing Marks:</label>
                        <input type="text" id="distinguishing-marks" name="distinguishing-marks" readonly>
                    </div>
                </div>
            
                <div class="form-section">
                    <h2>4. Educational Background</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>School</th>
                                <th>Educational Level</th>
                                <th>School Year - Graduated</th>
                                <th>Degree</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" name="school[]" readonly></td>
                                <td><input type="text" name="educational-level[]" readonly></td>
                                <td><input type="text" name="school-year[]" readonly></td>
                                <td><input type="text" name="degree[]" readonly></td>
                            </tr>
                            <tr>
                                <td><input type="text" name="school[]" readonly></td>
                                <td><input type="text" name="educational-level[]" readonly></td>
                                <td><input type="text" name="school-year[]" readonly></td>
                                <td><input type="text" name="degree[]" readonly></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            
                <div class="form-section">
                    <h2>5. Course Title (for TPIS, CACs)</h2>
                    <div class="grid">
                        <div class="form-group">
                            <label for="course-title">5.1. Course Title:</label>
                            <input type="text" id="course-title" name="course-title" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="training-duration">Training Duration (No. of Hrs.):</label>
                            <input type="number" id="training-duration" name="training-duration" required readonly>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label for="schedule-from">From:</label>
                            <input type="date" id="schedule-from" name="schedule-from" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="schedule-to">To:</label>
                            <input type="date" id="schedule-to" name="schedule-to" required readonly>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label for="aptitude-exam-date">5.3. Aptitude Exam Schedule Date:</label>
                            <input type="date" id="aptitude-exam-date" name="aptitude-exam-date" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="aptitude-exam-time">Time:</label>
                            <input type="time" id="aptitude-exam-time" name="aptitude-exam-time" required readonly>
                        </div>
                    </div>
                </div>
            
                <div class="form-section">
                    <h2>6. Competency Assessment to Take</h2>
                    <div class="grid">
                        <div class="form-group">
                            <label for="application-date">6.1. Date of Application:</label>
                            <input type="date" id="application-date" name="application-date" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="sector-component">6.2. Sector Component:</label>
                            <input type="text" id="sector-component" name="sector-component" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="trade-area">6.3. Trade Area:</label>
                            <input type="text" id="trade-area" name="trade-area" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="occupation">6.4. Occupation:</label>
                            <input type="text" id="occupation" name="occupation" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="classification">6.5. Classification:</label>
                            <input type="text" id="classification" name="classification" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="competency">6.6. Competency:</label>
                            <input type="text" id="competency" name="competency" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="training-program">6.7. Training Program:</label>
                            <input type="text" id="training-program" name="training-program" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="program-sector">6.8. Program Sector:</label>
                            <input type="text" id="program-sector" name="program-sector" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="client-type">6.9. Client Type:</label>
                            <input type="text" id="client-type" name="client-type" required readonly>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>7. Working Experience</h2>
        
                    <table id="experience-table">
                        <div class="grid">
                            <div class="form-group">
                                <label for="years_of_experience">Total Years of Work Experience:</label>
                                <input type="number" id="years_of_experience" name="years_of_experience" required readonly>
                            </div>
                            <div class="form-group">
                                <label for="training_hours">Total Training Hours:</label>
                                <input type="number" id="training_hours" name="training_hours" required readonly>
                            </div>
                            <div class="form-group">
                                <label for="training_institution">Training Institution:</label>
                                <input type="text" id="training_institution" name="training_institution" required readonly>
                            </div>
                            <div class="form-group">
                                <label for="type_training_institution">Type of Training Institution:</label>
                                <select id="type_training_institution" name="type_training_institution" required disabled>
                                    <option value="">Select</option>
                                    <option value="private">Private</option>
                                    <option value="public">Public</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="educational_attainment">Educational Attainment:</label>
                                <select id="educational_attainment" name="educational_attainment" required disabled>
                                    <option value="">Select</option>
                                    <option value="high-school">High School</option>
                                    <option value="college">College</option>
                                    <option value="vocational">Vocational</option>
                                    <option value="post-graduate">Post-Graduate</option>
                                </select>
                            </div>
                        </div>
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Position</th>
                                <th>Dates</th>
                                <th>Salary</th>
                                <th>Years of Experience</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" name="company[]" readonly></td>
                                <td><input type="text" name="position[]" readonly></td>
                                <td><input type="text" name="dates[]" readonly></td>
                                <td><input type="number" name="salary[]" readonly></td>
                                <td><input type="number" name="years-of-experience[]" readonly></td>
                            </tr>
                            <tr>
                                <td><input type="text" name="company[]" readonly></td>
                                <td><input type="text" name="position[]" readonly></td>
                                <td><input type="text" name="dates[]" readonly></td>
                                <td><input type="number" name="salary[]" readonly></td>
                                <td><input type="number" name="years-of-experience[]" readonly></td>
                            </tr>
                        </tbody>
                    </table>
              
                </div>
                
                <div class="form-section">
                    <h2>8. Other Training/Seminars Attended</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Venue</th>
                                <th>Dates</th>
                                <th>Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" name="training-title[]" readonly></td>
                                <td><input type="text" name="training-venue[]" readonly></td>
                                <td><input type="text" name="training-dates[]" readonly></td>
                                <td><input type="number" name="training-hours[]" readonly></td>
                            </tr>
                            <tr>
                                <td><input type="text" name="training-title[]" readonly></td>
                                <td><input type="text" name="training-venue[]" readonly></td>
                                <td><input type="text" name="training-dates[]" readonly></td>
                                <td><input type="number" name="training-hours[]" readonly></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="form-section">
                    <h2>9. Licenses/Examinations Passed</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Year</th>
                                <th>Rating</th>
                                <th>Expiry</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" name="license-title[]" readonly></td>
                                <td><input type="number" name="license-year[]" readonly></td>
                                <td><input type="text" name="license-rating[]" readonly></td>
                                <td><input type="date" name="license-expiry[]" readonly></td>
                            </tr>
                            <tr>
                                <td><input type="text" name="license-title[]" readonly></td>
                                <td><input type="number" name="license-year[]" readonly></td>
                                <td><input type="text" name="license-rating[]" readonly></td>
                                <td><input type="date" name="license-expiry[]" readonly></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="form-section">
                    <h2>10. Competency Assessment Passed</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Sector</th>
                                <th>Trade Area</th>
                                <th>Occupation</th>
                                <th>Classification Level</th>
                                <th>Competency</th>
                                <th>Specialization Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" name="competency-sector[]" readonly></td>
                                <td><input type="text" name="competency-trade[]" readonly></td>
                                <td><input type="text" name="competency-occupation[]" readonly></td>
                                <td><input type="text" name="classification-level[]" readonly></td>
                                <td><input type="text" name="competency[]" readonly></td>
                                <td><input type="text" name="specialization-description[]" readonly></td>
                            </tr>
                            <tr>
                                <td><input type="text" name="competency-sector[]" readonly></td>
                                <td><input type="text" name="competency-trade[]" readonly></td>
                                <td><input type="text" name="competency-occupation[]" readonly></td>
                                <td><input type="text" name="classification-level[]" readonly></td>
                                <td><input type="text" name="competency[]" readonly></td>
                                <td><input type="text" name="specialization-description[]" readonly></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="form-section family-background">
                    <h2>11. Family Background</h2>
                    <div class="grid">
                        <div class="form-group">
                            <label for="spouse-name">11.1. Spouse's Name:</label>
                            <input type="text" id="spouse-name" name="spouse-name" readonly>
                        </div>
                        <div class="form-group">
                            <label for="spouse-education">11.2. Educational Attainment:</label>
                            <input type="text" id="spouse-education" name="spouse-education" readonly>
                        </div>
                        <div class="form-group">
                            <label for="spouse-occupation">11.3. Occupation:</label>
                            <input type="text" id="spouse-occupation" name="spouse-occupation" readonly>
                        </div>
                        <div class="form-group">
                            <label for="spouse-income">11.4. Ave. Monthly Income:</label>
                            <input type="text" id="spouse-income" name="spouse-income" readonly>
                        </div>
                        <div class="form-group">
                            <label for="father-name">11.5. Father's Name:</label>
                            <input type="text" id="father-name" name="father-name" readonly>
                        </div>
                        <div class="form-group">
                            <label for="father-education">11.6. Educational Attainment:</label>
                            <input type="text" id="father-education" name="father-education" readonly>
                        </div>
                        <div class="form-group">
                            <label for="father-occupation">11.7. Occupation:</label>
                            <input type="text" id="father-occupation" name="father-occupation" readonly>
                        </div>
                        <div class="form-group">
                            <label for="father-income">11.8. Ave. Monthly Income:</label>
                            <input type="text" id="father-income" name="father-income" readonly>
                        </div>
                        <div class="form-group">
                            <label for="mother-name">11.9. Mother's Name:</label>
                            <input type="text" id="mother-name" name="mother-name" readonly>
                        </div>
                        <div class="form-group">
                            <label for="mother-education">11.10. Educational Attainment:</label>
                            <input type="text" id="mother-education" name="mother-education" readonly>
                        </div>
                        <div class="form-group">
                            <label for="mother-occupation">11.11. Occupation:</label>
                            <input type="text" id="mother-occupation" name="mother-occupation" readonly>
                        </div>
                        <div class="form-group">
                            <label for="mother-income">11.12. Ave. Monthly Income:</label>
                            <input type="text" id="mother-income" name="mother-income" readonly>
                        </div>
                        <div class="form-group">
                            <label for="guardian-name">11.13. Name of Guardian:</label>
                            <input type="text" id="guardian-name" name="guardian-name" readonly>
                        </div>
                        <div class="form-group">
                            <label for="guardian-education">11.14. Educational Attainment:</label>
                            <input type="text" id="guardian-education" name="guardian-education" readonly>
                        </div>
                        <div class="form-group">
                            <label for="guardian-occupation">11.15. Occupation:</label>
                            <input type="text" id="guardian-occupation" name="guardian-occupation" readonly>
                        </div>
                        <div class="form-group">
                            <label for="guardian-income">11.16. Ave. Monthly Income:</label>
                            <input type="text" id="guardian-income" name="guardian-income" readonly>
                        </div>
                        <div class="form-group">
                            <label for="dependents">11.17. Dependents:</label>
                            <input type="text" id="dependents" name="dependents" readonly>
                        </div>
                        <div class="form-group">
                            <label for="dependent-age">11.18. Age Dependent:</label>
                            <input type="text" id="dependent-age" name="dependent-age" readonly>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>12. NTTC Application Form</h2>
                    <div class="form-row grid">
                        <div class="form-group">
                            <label for="sector" style="text-transform: uppercase;">Sector</label>
                            <input type="text" id="sector" name="sector" placeholder="Enter sector" required readonly style="text-transform: uppercase; width: 80%;">
                        </div>
                        <div class="form-group">
                            <label for="qualification" style="text-transform: uppercase;">Qualification</label>
                            <input type="text" id="qualification" name="qualification" placeholder="Enter qualification" required readonly style="text-transform: uppercase; width: 100%; margin-right: 5px; margin-left: 0;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="nttcstatus" style="text-transform: uppercase;">NTTC Status</label>
                        <input type="text" id="nttcstatus" name="nttcstatus" placeholder="Enter NTTC Status" required readonly style="text-transform: uppercase; width: calc(98.7% + 20px); margin-right: 5px; margin-left: -0px;">
                    </div>
                </div>
                    
                    <div class="form-group">
                        <label for="nc_cert_number">NC Certificate Number</label>
                        <input type="text" id="nc_cert_number" name="nc_cert_number" placeholder="Enter NC certificate number" required maxlength="14" readonly>
                    </div>
                    
                    <div class="form-row grid">
                        <div class="form-group">
                            <label for="nc_date_issuance">NC Date of Issuance</label>
                            <input type="date" id="nc_date_issuance" name="nc_date_issuance" required onchange="setNCValidity()" readonly>
                        </div>
                        <div class="form-group">
                            <label for="nc_validity">NC Validity</label>
                            <input type="date" id="nc_validity" name="nc_validity" required readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="tm_cert_number">TM Certificate Number</label>
                        <div style="display: flex; align-items: center;">
                            <span style="width: 60px; background-color: #f0f0f0; border: 1px solid #ccc; padding: 10px; margin-right: -1px; border-radius: 4px 0 0 4px; display: flex; align-items: center;">TMC-</span>
                            <input type="text" id="tm_cert_number_actual" name="tm_cert_number_actual" 
                                placeholder="Enter 14 digits" 
                                required 
                                pattern="[0-9]{14}" 
                                maxlength="14" 
                                readonly
                                style="width: calc(100% - 60px); border-radius: 0 4px 4px 0; background-color: #f0f0f0;">
                        </div>
                    </div>
                    
                    <div class="form-row grid">
                        <div class="form-group">
                            <label for="tm_date_issuance">TM Date of Issuance</label>
                            <input type="date" id="tm_date_issuance" name="tm_date_issuance" required onchange="setTMValidity()" readonly>
                        </div>
                        <div class="form-group">
                            <label for="tm_validity">TM Validity</label>
                            <input type="date" id="tm_validity" name="tm_validity" required readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="assessor1">Assessor 1</label>
                        <input type="text" id="assessor1" name="assessor1" placeholder="Enter assessor 1 name" required readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="assessor2">Assessor 2</label>
                        <input type="text" id="assessor2" name="assessor2" placeholder="Enter assessor 2 name" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="assessor3">Assessor 3</label>
                        <input type="text" id="assessor3" name="assessor3" placeholder="Enter assessor 3 name" readonly>
                    </div>
                </div>
                <button type="button" class="btn" id="editToggle" onclick="toggleEdit()">Edit Form</button>
                <button type="button" class="btn btn-secondary" onclick="savePDF()">Save as PDF</button>
                <button type="button" class="btn btn-primary" id="importButton">Import to NTTC Registry</button>
                <button type="button" class="btn btn-primary" id="sendToPO" onclick="sendToProvincialOffice()" style="border: 2px solid #000000;">
                    Send Application to Provincial Office
                </button>
            </div>
        </form>
    </div>
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Send Application Email</h2>
            <form id="emailForm" onsubmit="sendEmail(event)">
                <div class="form-group">
                    <label for="emailSubject">Subject:</label>
                    <input type="text" id="emailSubject" readonly>
                </div>
                <div class="form-group">
                    <label for="emailBody">Message:</label>
                    <textarea id="emailBody" rows="10" readonly></textarea>
                </div>
                <button type="submit" class="btn">Send Email</button>
            </form>
        </div>
    </div>

    <!-- Modal for displaying information -->
    <div id="dataModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Submitted Information</h2>
            <div id="modalContent" style="display: flex; flex-direction: column;">
                <!-- Information will be populated here -->
            </div>
        </div>
    </div>

    <!-- Add this modal HTML before the closing body tag -->
    <div id="successModal" class="modal">
        <div class="modal-content" style="background-color: #fff; max-width: 400px; text-align: center; padding: 30px;">
            <img src="../icons/success.png" alt="Success" style="width: 64px; height: 64px; margin-bottom: 20px;">
            <h2 style="color: #28a745; margin-bottom: 15px;">Success!</h2>
            <p style="margin-bottom: 20px;">Your application has been successfully submitted to the Provincial Office.</p>
            <button class="btn" style="background-color: #28a745;" onclick="closeSuccessModal()">OK</button>
        </div>
    </div>

    <!-- Add this loading modal HTML before the closing body tag -->
    <div id="loadingModal" class="modal">
        <div class="modal-content" style="background-color: #fff; max-width: 400px; text-align: center; padding: 30px;">
            <div class="loading-spinner" style="margin-bottom: 20px;"></div>
            <h2 style="margin-bottom: 15px;">Submitting Application</h2>
            <p>Please wait while we submit your application...</p>
        </div>
    </div>

    <!-- Add a modal for displaying the ticket number -->
    <div id="ticketModal" class="modal">
        <div class="modal-content" style="background-color: #fff; max-width: 400px; text-align: center; padding: 30px;">
            <img src="../icons/success.png" alt="Success" style="width: 64px; height: 64px; margin-bottom: 20px;">
            <h2 style="color: #28a745; margin-bottom: 15px;">Application Sent Successfully!</h2>
            <p style="margin-bottom: 20px;">Your ticket number is:</p>
            <h3 id="ticketNumber" style="color: #ff0000; font-size: 24px; margin-bottom: 20px;"></h3>
            <p style="margin-bottom: 20px;">Please keep this number for your records. You will need it when visiting the Provincial Office.</p>
            <button class="btn" style="background-color: #28a745;" onclick="closeTicketModal()">OK</button>
        </div>
    </div>

    <script>
function savePDF() {
    window.print();
}

    // Function to get query parameters and populate the form
    function populateForm() {
        const params = new URLSearchParams(window.location.search);
        
        // If no URL parameters, try to get from localStorage (for testing)
        if (params.toString() === '') {
            console.log('No URL parameters found, checking localStorage...');
            const storedData = localStorage.getItem('formData');
            if (storedData) {
                try {
                    const parsedData = JSON.parse(storedData);
                    // Convert stored data to URLSearchParams format for processing
                    const urlParams = new URLSearchParams();
                    Object.entries(parsedData).forEach(([key, value]) => {
                        urlParams.set(key, value);
                    });
                    return populateFormFromParams(urlParams);
                } catch (e) {
                    console.error('Error parsing stored form data:', e);
                }
            }
        }
        
        return populateFormFromParams(params);
    }
    
    // Helper function to set field value with fallback and error checking
    function setFieldValue(id, value, fallback = "") {
        const el = document.getElementById(id);
        if (!el) {
            console.warn(`Element ${id} not found`);
            return;
        }
        el.value = value !== null && value !== "" ? value : fallback;
        console.log(`${id}:`, el.value);
    }
    
    // Helper function to populate form from URLSearchParams
    function populateFormFromParams(params) {
        // Debug: Log all URL parameters
        console.log('All URL parameters:');
        for (const [key, value] of params.entries()) {
            console.log(`${key}: ${value}`);
        }
        
        // 1. TESDA Section
        document.getElementById('nmis-code').value = params.get('nmis-code') || 'N/A';
        document.getElementById('nmis-date').value = params.get('nmis-date') || 'N/A';
    
        // 2. Manpower Profile
        document.getElementById('last_name').value = params.get('last-name') || 'N/A';
        document.getElementById('first_name').value = params.get('first-name') || 'N/A';
        document.getElementById('middle_initial').value = params.get('middle-name') || 'N/A';
        document.getElementById('extension').value = params.get('extension');
        document.getElementById('address').value = params.get('address') || 'N/A';
        document.getElementById('city').value = params.get('city') || 'N/A';
        document.getElementById('province').value = params.get('province') || 'N/A';
        document.getElementById('region').value = params.get('region') || 'N/A';
        document.getElementById('zip-code').value = params.get('zip-code') || 'N/A';
        document.getElementById('po-box').value = params.get('po-box') || 'N/A';
        document.getElementById('sex').value = params.get('sex') || 'N/A';
        document.getElementById('civil-status').value = params.get('civil-status') || 'N/A';
        document.getElementById('contact').value = params.get('contact') || 'N/A';
        document.getElementById('telephone').value = params.get('telephone') || 'N/A';
        document.getElementById('email').value = params.get('email') || 'N/A';
        document.getElementById('fax').value = params.get('fax') || 'N/A';
        document.getElementById('employment-type').value = params.get('employment-type') || 'N/A';
        document.getElementById('employment-status').value = params.get('employment-status') || 'N/A';
    
        // 3. Personal Information
        document.getElementById('birthdate').value = params.get('birthdate') || 'N/A';
        document.getElementById('birthplace').value = params.get('birthplace') || 'N/A';
        document.getElementById('citizenship').value = params.get('citizenship') || 'N/A';
        document.getElementById('religion').value = params.get('religion') || 'N/A';
        document.getElementById('height').value = params.get('height') || 'N/A';
        document.getElementById('weight').value = params.get('weight') || 'N/A';
        document.getElementById('blood-type').value = params.get('blood-type') || 'N/A';
        document.getElementById('sss').value = params.get('sss') || 'N/A';
        document.getElementById('gsis').value = params.get('gsis') || 'N/A';
        document.getElementById('tin').value = params.get('tin') || 'N/A';
        document.getElementById('distinguishing-marks').value = params.get('distinguishing-marks') || 'N/A';
    
        // 4. Educational Background
        const schoolInputs = document.querySelectorAll('input[name="school[]"]');
        const educLevelInputs = document.querySelectorAll('input[name="educational-level[]"]');
        const schoolYearInputs = document.querySelectorAll('input[name="school-year[]"]');
        const degreeInputs = document.querySelectorAll('input[name="degree[]"]');
    
        for (let i = 0; i < schoolInputs.length; i++) {
            schoolInputs[i].value = params.getAll('school[]')[i] || 'N/A';
            educLevelInputs[i].value = params.getAll('educational-level[]')[i] || 'N/A';
            schoolYearInputs[i].value = params.getAll('school-year[]')[i] || 'N/A';
            degreeInputs[i].value = params.getAll('degree[]')[i] || 'N/A';
        }
    
        // 5. Course Title
        document.getElementById('course-title').value = params.get('course-title') || 'N/A';
        document.getElementById('training-duration').value = params.get('training-duration') || 'N/A';
        document.getElementById('schedule-from').value = params.get('schedule-from') || 'N/A';
        document.getElementById('schedule-to').value = params.get('schedule-to') || 'N/A';
        document.getElementById('aptitude-exam-date').value = params.get('aptitude-exam-date') || 'N/A';
        document.getElementById('aptitude-exam-time').value = params.get('aptitude-exam-time') || 'N/A';
    
        // 6. Competency Assessment
        document.getElementById('application-date').value = params.get('application-date') || 'N/A';
        document.getElementById('sector-component').value = params.get('sector-component') || 'N/A';
        document.getElementById('trade-area').value = params.get('trade-area') || 'N/A';
        document.getElementById('occupation').value = params.get('occupation') || 'N/A';
        document.getElementById('classification').value = params.get('classification') || 'N/A';
        document.getElementById('competency').value = params.get('competency') || 'N/A';
        document.getElementById('training-program').value = params.get('training-program') || 'N/A';
        document.getElementById('program-sector').value = params.get('program-sector') || 'N/A';
        document.getElementById('client-type').value = params.get('client-type') || 'N/A';
    
        // 7. Working Experience
        // Use helper for these fields
        setFieldValue("years_of_experience", params.get("years_of_experience"), "");
        setFieldValue("training_institution", params.get("training_institution"), "");
        // For selects, set value before disabling
        const typeTrainingVal = params.get("type_training_institution");
        setFieldValue("type_training_institution", typeTrainingVal, "private");
        const typeTrainingEl = document.getElementById("type_training_institution");
        if (typeTrainingEl) typeTrainingEl.disabled = true;
        const educationalVal = params.get("educational_attainment");
        setFieldValue("educational_attainment", educationalVal, "college");
        const educationalEl = document.getElementById("educational_attainment");
        if (educationalEl) educationalEl.disabled = true;
        
        const companyInputs = document.querySelectorAll('input[name="company[]"]');
        const positionInputs = document.querySelectorAll('input[name="position[]"]');
        const datesInputs = document.querySelectorAll('input[name="dates[]"]');
        const salaryInputs = document.querySelectorAll('input[name="salary[]"]');
        const expYearsInputs = document.querySelectorAll('input[name="years-of-experience[]"]');
        
        // Add this check for training_hours
        const trainingHoursInput = document.getElementById('training_hours');
        trainingHoursInput.value = params.get('training_hours') || ''; // Do not set to 'N/A' if empty

        for (let i = 0; i < companyInputs.length; i++) {
            companyInputs[i].value = params.getAll('company[]')[i] || 'N/A';
            positionInputs[i].value = params.getAll('position[]')[i] || 'N/A';
            datesInputs[i].value = params.getAll('dates[]')[i] || 'N/A';
            salaryInputs[i].value = params.getAll('salary[]')[i] || 'N/A';
            expYearsInputs[i].value = params.getAll('years-of-experience[]')[i] || 'N/A';
        }
    
        // 8. Other Training/Seminars
        const trainingTitleInputs = document.querySelectorAll('input[name="training-title[]"]');
        const trainingVenueInputs = document.querySelectorAll('input[name="training-venue[]"]');
        const trainingDatesInputs = document.querySelectorAll('input[name="training-dates[]"]');
        const trainingHoursInputs = document.querySelectorAll('input[name="training-hours[]"]');
    
        for (let i = 0; i < trainingTitleInputs.length; i++) {
            trainingTitleInputs[i].value = params.getAll('training-title[]')[i] || 'N/A';
            trainingVenueInputs[i].value = params.getAll('training-venue[]')[i] || 'N/A';
            trainingDatesInputs[i].value = params.getAll('training-dates[]')[i] || 'N/A';
            trainingHoursInputs[i].value = params.getAll('training-hours[]')[i] || '';
        }
    
        // 9. Licenses/Examinations
        const licenseTitleInputs = document.querySelectorAll('input[name="license-title[]"]');
        const licenseYearInputs = document.querySelectorAll('input[name="license-year[]"]');
        const licenseRatingInputs = document.querySelectorAll('input[name="license-rating[]"]');
        const licenseExpiryInputs = document.querySelectorAll('input[name="license-expiry[]"]');
    
        for (let i = 0; i < licenseTitleInputs.length; i++) {
            licenseTitleInputs[i].value = params.getAll('license-title[]')[i] || 'N/A';
            licenseYearInputs[i].value = params.getAll('license-year[]')[i] || 'N/A';
            licenseRatingInputs[i].value = params.getAll('license-rating[]')[i] || 'N/A';
            licenseExpiryInputs[i].value = params.getAll('license-expiry[]')[i] || 'N/A';
        }
    
        // 10. Competency Assessment Passed
        const compSectorInputs = document.querySelectorAll('input[name="competency-sector[]"]');
        const compTradeInputs = document.querySelectorAll('input[name="competency-trade[]"]');
        const compOccupationInputs = document.querySelectorAll('input[name="competency-occupation[]"]');
        const classificationLevelInputs = document.querySelectorAll('input[name="classification-level[]"]');
        const competencyInputs = document.querySelectorAll('input[name="competency[]"]');
        const specializationInputs = document.querySelectorAll('input[name="specialization-description[]"]');
    
        for (let i = 0; i < compSectorInputs.length; i++) {
            compSectorInputs[i].value = params.getAll('competency-sector[]')[i] || 'N/A';
            compTradeInputs[i].value = params.getAll('competency-trade[]')[i] || 'N/A';
            compOccupationInputs[i].value = params.getAll('competency-occupation[]')[i] || 'N/A';
            classificationLevelInputs[i].value = params.getAll('classification-level[]')[i] || 'N/A';
            competencyInputs[i].value = params.getAll('competency[]')[i] || 'N/A';
            specializationInputs[i].value = params.getAll('specialization-description[]')[i] || 'N/A';
        }
    
        // 11. Family Background
        document.getElementById('spouse-name').value = params.get('spouse-name') || 'N/A';
        document.getElementById('spouse-education').value = params.get('spouse-education') || 'N/A';
        document.getElementById('spouse-occupation').value = params.get('spouse-occupation') || 'N/A';
        document.getElementById('spouse-income').value = params.get('spouse-income') || 'N/A';
        document.getElementById('father-name').value = params.get('father-name') || 'N/A';
        document.getElementById('father-education').value = params.get('father-education') || 'N/A';
        document.getElementById('father-occupation').value = params.get('father-occupation') || 'N/A';
        document.getElementById('father-income').value = params.get('father-income') || 'N/A';
        document.getElementById('mother-name').value = params.get('mother-name') || 'N/A';
        document.getElementById('mother-education').value = params.get('mother-education') || 'N/A';
        document.getElementById('mother-occupation').value = params.get('mother-occupation') || 'N/A';
        document.getElementById('mother-income').value = params.get('mother-income') || 'N/A';
        document.getElementById('guardian-name').value = params.get('guardian-name') || 'N/A';
        document.getElementById('guardian-education').value = params.get('guardian-education') || 'N/A';
        document.getElementById('guardian-occupation').value = params.get('guardian-occupation') || 'N/A';
        document.getElementById('guardian-income').value = params.get('guardian-income') || 'N/A';
        document.getElementById('dependents').value = params.get('dependents') || 'N/A';
        document.getElementById('dependent-age').value = params.get('dependent-age') || 'N/A';
    
        // 12. NTTC Application Form
        const sectorValue = params.get('sector') || 'N/A';
        document.getElementById('sector').value = sectorValue.replace(/_/g, ' ');
        document.getElementById('qualification').value = params.get('qualification') || 'N/A';
        document.getElementById('nttcstatus').value = params.get('nttcstatus') || 'N/A';
        document.getElementById('nc_cert_number').value = params.get('nc_cert_number') || 'N/A';
        document.getElementById('nc_date_issuance').value = params.get('nc_date_issuance') || 'N/A';
        document.getElementById('nc_validity').value = params.get('nc_validity') || 'N/A';
        document.getElementById('tm_cert_number_actual').value = params.get('tm_cert_number') || 'N/A';
        document.getElementById('tm_date_issuance').value = params.get('tm_date_issuance') || 'N/A';
        document.getElementById('tm_validity').value = params.get('tm_validity') || 'N/A';
        document.getElementById('assessor1').value = params.get('assessor1') || 'N/A';
        document.getElementById('assessor2').value = params.get('assessor2') || 'N/A';
        document.getElementById('assessor3').value = params.get('assessor3') || 'N/A';

        const yearsOfExperienceInput = document.getElementById('years_of_experience');
        const trainingInstitutionInput = document.getElementById('training_institution');
        const typeTrainingInstitutionInput = document.getElementById('type_training_institution');
        const educationalAttainmentInput = document.getElementById('educational_attainment');
        
        if (yearsOfExperienceInput) {
            yearsOfExperienceInput.value = params.get('years_of_experience') || 'N/A';
        }
        if (trainingInstitutionInput) {
            trainingInstitutionInput.value = params.get('training_institution') || 'N/A';
        }
        
        // Properly set select field values
        const typeTrainingValue = params.get('type_training_institution');
        console.log('URL parameter type_training_institution:', typeTrainingValue);
        if (typeTrainingValue && typeTrainingInstitutionInput) {
            // Handle different possible formats
            const normalizedValue = typeTrainingValue.toLowerCase().trim();
            if (normalizedValue === 'private' || normalizedValue === 'public') {
                typeTrainingInstitutionInput.disabled = false; // Temporarily enable
                typeTrainingInstitutionInput.value = normalizedValue;
                typeTrainingInstitutionInput.disabled = true; // Disable again
                console.log('Set type_training_institution to:', normalizedValue);
            } else {
                console.log('Invalid type_training_institution value:', typeTrainingValue);
            }
        } else {
            console.log('type_training_institution not found in URL or element not found');
            // Set default value if not provided
            if (typeTrainingInstitutionInput) {
                typeTrainingInstitutionInput.disabled = false; // Temporarily enable
                typeTrainingInstitutionInput.value = 'private';
                typeTrainingInstitutionInput.disabled = true; // Disable again
                console.log('Set default type_training_institution to: private');
            }
        }
        
        const educationalValue = params.get('educational_attainment');
        console.log('URL parameter educational_attainment:', educationalValue);
        if (educationalValue && educationalAttainmentInput) {
            // Handle different possible formats
            const normalizedValue = educationalValue.toLowerCase().trim();
            const validOptions = ['high-school', 'college', 'vocational', 'post-graduate'];
            if (validOptions.includes(normalizedValue)) {
                educationalAttainmentInput.disabled = false; // Temporarily enable
                educationalAttainmentInput.value = normalizedValue;
                educationalAttainmentInput.disabled = true; // Disable again
                console.log('Set educational_attainment to:', normalizedValue);
            } else {
                console.log('Invalid educational_attainment value:', educationalValue);
            }
        } else {
            console.log('educational_attainment not found in URL or element not found');
            // Set default value if not provided
            if (educationalAttainmentInput) {
                educationalAttainmentInput.disabled = false; // Temporarily enable
                educationalAttainmentInput.value = 'college';
                educationalAttainmentInput.disabled = true; // Disable again
                console.log('Set default educational_attainment to: college');
            }
        }
        
    }
    
    // Call the function when the page loads
    window.onload = async function() {
        // Always load from Firestore using ticket number from URL
        const params = new URLSearchParams(window.location.search);
        const ticketNumber = params.get('ticketNumber');
        if (ticketNumber) {
            try {
                await loadDataFromFirebase(ticketNumber);
            } catch (error) {
                console.error('Could not load from Firebase:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Could not load application data from Firestore.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        } else {
            Swal.fire({
                title: 'Error!',
                text: 'No ticket number provided in URL.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
        // Ensure select fields are disabled by default
        const selects = document.querySelectorAll('#tesdaForm select');
        selects.forEach(select => {
            select.disabled = true;
        });
        console.log('Form populated from Firestore');
    };

function submitForm() {
    const fields = [
        "last_name", "first_name", "middle_initial", "extension", "birthdate", "sex",
        "address", "training_institution", "type_training_institution", "contact_number",
        "educational_attainment", "training_hours", "years_of_experience", "sector",
        "qualification","nttcstatus", "nc_cert_number", "nc_date_issuance", "nc_validity",
        "tm_cert_number_actual", "tm_date_issuance", "tm_validity", "assessor1",
        "assessor2", "assessor3", "nttc_serial_number", "nttc_cert_number",
        "nttc_date_issuance", "nttc_validity", "status"
    ];

    // Dynamically create form fields only if formContainer exists
    const formContainer = document.getElementById('formContainer');
    if (formContainer) {
        fields.forEach(field => {
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';

            const label = document.createElement('label');
            label.textContent = field.replace(/_/g, ' ').toUpperCase();
            label.setAttribute('for', field);

            const input = document.createElement('input');
            input.type = 'text';
            input.id = field;
            input.name = field;

            formGroup.appendChild(label);
            formGroup.appendChild(input);
            formContainer.appendChild(formGroup);
        });
    }

    // Handle form submission
    document.getElementById('submitButton').addEventListener('click', (event) => {
        event.preventDefault(); // Prevent the default form submission behavior

        const formData = {};

        fields.forEach(field => {
            const input = document.getElementById(field);
            formData[field] = input ? input.value : ''; // Check if input exists
        });

        // Create and display the modal with the form data
        const modal = document.getElementById('dataModal');
        const modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = ''; // Clear previous content

        // Populate modal with form data
        for (const [key, value] of Object.entries(formData)) {
            const dataRow = document.createElement('div');
            dataRow.style.display = 'flex';
            dataRow.style.justifyContent = 'space-between';
            dataRow.style.marginBottom = '10px';

            const label = document.createElement('span');
            label.textContent = key.replace(/_/g, ' ').toUpperCase() + ':';
            label.style.fontWeight = 'bold';

            const data = document.createElement('span');
            data.textContent = value;

            dataRow.appendChild(label);
            dataRow.appendChild(data);
            modalContent.appendChild(dataRow);
        }

        // Show the modal
        modal.style.display = 'block';
    });

    // Close modal when clicking outside of it
    window.onclick = function(event) {
        const modal = document.getElementById('dataModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };
}

let isEditing = false; // Track the editing state

function toggleEdit() {
    const inputs = document.querySelectorAll('#tesdaForm input');
    const selects = document.querySelectorAll('#tesdaForm select');
    isEditing = !isEditing; // Toggle the editing state

    inputs.forEach(input => {
        input.readOnly = !isEditing; // Set readonly based on editing state
    });

    selects.forEach(select => {
        select.disabled = !isEditing; // Set disabled for select fields
    });

    // Update button text based on the current state
    const editButton = document.getElementById('editToggle');
    if (isEditing) {
        editButton.textContent = 'Save Changes';
        editButton.style.backgroundColor = '#28a745'; // Green for save
    } else {
        editButton.textContent = 'Edit Form';
        editButton.style.backgroundColor = '#ff0000'; // Red for edit
        // Save changes to Firebase when switching back to readonly
        saveChangesToFirebase();
    }
}

function openModal() {
    const modal = document.getElementById('dataModal');
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = ''; // Clear previous content

    // Populate modal with form data
    const fields = [
        "last_name", "first_name", "middle_initial", "extension", "birthdate", "sex",
        "address", "training_institution", "type_training_institution", "contact_number",
        "educational_attainment", "training_hours", "years_of_experience", "sector",
        "qualification", "nc_cert_number", "nc_date_issuance", "nc_validity",
        "tm_cert_number_actual", "tm_date_issuance", "tm_validity", "assessor1",
        "assessor2", "assessor3", "nttc_serial_number", "nttc_cert_number",
        "nttc_date_issuance", "nttc_validity"
    ];

    fields.forEach(field => {
        const input = document.getElementById(field);
        const dataRow = document.createElement('div');
        dataRow.style.display = 'flex';
        dataRow.style.justifyContent = 'space-between';
        dataRow.style.marginBottom = '10px';

        const label = document.createElement('span');
        label.textContent = field.replace(/_/g, ' ').toUpperCase() + ':';
        label.style.fontWeight = 'bold';

        const data = document.createElement('span');
        data.textContent = input ? input.value : ''; // Check if input exists

        dataRow.appendChild(label);
        dataRow.appendChild(data);
        modalContent.appendChild(dataRow);
    });

    modal.style.display = 'block'; // Show the modal
}

function closeModal() {
    const modal = document.getElementById('dataModal');
    modal.style.display = 'none'; // Hide the modal
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('dataModal');
    if (event.target === modal) {
        closeModal();
    }
};

document.getElementById('importButton').addEventListener('click', async function() {
    try {
        // Disable button and show loading state
        const importButton = this;
        const originalText = importButton.innerHTML;
        importButton.disabled = true;
        importButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Importing...';

        // Helper function to safely get input value
        const getValue = (elementId) => {
            const element = document.getElementById(elementId);
            return element ? element.value : '';
        };

        // Collect all required data
    const data = {
            "last_name": getValue('last_name'),
            "first_name": getValue('first_name'),
            "middle_initial": getValue('middle_initial'),
            "extension": getValue('extension'),
            "birthdate": getValue('birthdate'),
            "sex": getValue('sex'),
            "address": getValue('address'),
            "training_institution": getValue('training_institution'),
            "type_training_institution": getValue('type_training_institution'),
            "email": getValue('email'),
            "contact_number": getValue('contact'),
            "educational_attainment": getValue('educational_attainment'),
            "training_hours": getValue('training_hours'),
            "years_of_experience": getValue('years_of_experience'),
            "sector": getValue('sector'),
            "qualification": getValue('qualification'),
            "nttcstatus": getValue('nttcstatus') || 'Pending',
            "nc_cert_number": getValue('nc_cert_number'),
            "nc_date_issuance": getValue('nc_date_issuance'),
            "nc_validity": getValue('nc_validity'),
            "tm_cert_number": getValue('tm_cert_number_actual'),
            "tm_date_issuance": getValue('tm_date_issuance'),
            "tm_validity": getValue('tm_validity'),
            "assessor1": getValue('assessor1'),
            "assessor2": getValue('assessor2'),
            "assessor3": getValue('assessor3'),
            "applicationStatus": getValue('status') || 'Pending',
            "importDate": new Date().toISOString(),
            "province": getValue('province'),
            "region": getValue('region'),
            "city": getValue('city')
        };

        // Validate required fields
        const requiredFields = [
            'last_name', 'first_name', 'contact_number', 
            'sector', 'qualification', 'training_institution'
        ];

        const missingFields = requiredFields.filter(field => !data[field]);
        
        if (missingFields.length > 0) {
            throw new Error(`Please fill in all required fields: ${missingFields.join(', ')}`);
        }

        // Store in localStorage
    localStorage.setItem('nttcData', JSON.stringify(data));

        // Show success message
        Swal.fire({
            title: 'Success!',
            text: 'Application data has been prepared for NTTC Registry',
            icon: 'success',
            showCancelButton: true,
            confirmButtonText: 'Go to Registry',
            cancelButtonText: 'Stay Here'
        }).then((result) => {
            if (result.isConfirmed) {
    window.location.href = '../admindash/nttcregistry.html';
            } else {
                // Reset button state if staying on page
                importButton.disabled = false;
                importButton.innerHTML = originalText;
            }
        });

    } catch (error) {
        console.error('Error preparing NTTC data:', error);
        
        // Show error message
        Swal.fire({
            title: 'Error!',
            text: error.message || 'Failed to prepare NTTC data. Please try again.',
            icon: 'error',
            confirmButtonText: 'OK'
        }).finally(() => {
            // Reset button state
            importButton.disabled = false;
            importButton.innerHTML = originalText;
        });
    }
});

// Update the setNCValidity function to calculate exactly 5 years minus 1 day
function setNCValidity() {
    const issuanceDate = document.getElementById('nc_date_issuance').value;
    const validityInput = document.getElementById('nc_validity');

    if (issuanceDate) {
        const date = new Date(issuanceDate);
        date.setFullYear(date.getFullYear() + 5); // Add 5 years
        date.setDate(date.getDate() - 1); // Subtract 1 day
        validityInput.value = date.toISOString().split('T')[0];
    } else {
        validityInput.value = '';
    }
}

// Update the setTMValidity function to calculate exactly 5 years minus 1 day
function setTMValidity() {
    const issuanceDate = document.getElementById('tm_date_issuance').value;
    const validityInput = document.getElementById('tm_validity');

    if (issuanceDate) {
        const date = new Date(issuanceDate);
        date.setFullYear(date.getFullYear() + 5); // Add 5 years
        date.setDate(date.getDate() - 1); // Subtract 1 day
        validityInput.value = date.toISOString().split('T')[0];
    } else {
        validityInput.value = '';
    }
}

// Update the handleTMCertInput function with a stricter implementation
function handleTMCertInput(input) {
    // First, get the current value
    let value = input.value;
    
    // Strip all TMC- prefixes and any non-numeric characters
    value = value.replace(/""/g, '').replace(/[^0-9]/g, '');
    
    // Limit to 14 digits
    value = value.slice(0, 14);
    
    // Add single TMC- prefix
        value = '' + value;
    
    // Set the cleaned value
    input.value = value;
    
    // Store the cleaned value in localStorage to persist it
    localStorage.setItem('tmCertNumber', value);
}

// Add form submit handler
document.getElementById('tesdaForm').addEventListener('submit', function(e) {
        const tmCertInput = document.getElementById('tm_cert_number_actual');
    if (tmCertInput) {
            handleTMCertInput(tmCertInput);
    }
});

// Add this to your existing DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
    const tmCertInput = document.getElementById('tm_cert_number_actual');
    if (tmCertInput) {
        // Restore from localStorage if exists
        const savedValue = localStorage.getItem('tmCertNumber');
        if (savedValue) {
            tmCertInput.value = savedValue;
        }
        
        // Clean up on load
        handleTMCertInput(tmCertInput);
        
        // Add input event listener
        tmCertInput.addEventListener('input', function() {
            handleTMCertInput(this);
        });
        
        // Add focus event listener
        tmCertInput.addEventListener('focus', function() {
            handleTMCertInput(this);
        });
        
        // Add blur event listener
        tmCertInput.addEventListener('blur', function() {
            handleTMCertInput(this);
        });
    }
});

// Handle browser back button
window.onpageshow = function(event) {
    if (event.persisted) {
        const tmCertInput = document.getElementById('tm_cert_number_actual');
        if (tmCertInput) {
            handleTMCertInput(tmCertInput);
        }
    }
};

// Add this to prevent multiple TMC- on form submission
if (document.getElementById('importButton')) {
    document.getElementById('importButton').addEventListener('click', function() {
        const tmCertInput = document.getElementById('tm_cert_number_actual');
        if (tmCertInput) {
            handleTMCertInput(tmCertInput);
        }
    });
}

if (document.getElementById('submitToProvincial')) {
    document.getElementById('submitToProvincial').addEventListener('click', function() {
        const tmCertInput = document.getElementById('tm_cert_number_actual');
        if (tmCertInput) {
            handleTMCertInput(tmCertInput);
        }
    });
}

async function sendToProvincialOffice() {
    try {
        // Show loading modal
        document.getElementById('loadingModal').style.display = 'block';

        // Helper function to safely get element value
        const getValue = (id) => {
            const element = document.getElementById(id);
            return element ? element.value : 'N/A';
        };

        // Get the next ticket number from Firestore using a transaction
        const countersCollection = collection(window.firestore, 'counters');
        const ticketCounterDoc = doc(countersCollection, 'ticketNumber');
        let ticketNumberValue = 1; // Default to 1 if not found

        await window.runTransaction(window.firestore, async (transaction) => {
            const counterDoc = await transaction.get(ticketCounterDoc);
            if (!counterDoc.exists()) {
                // If the counter doc doesn't exist, create it with value 1
                transaction.set(ticketCounterDoc, { current: 1 });
                ticketNumberValue = 1;
            } else {
                const current = counterDoc.data().current || 0;
                ticketNumberValue = current + 1;
                transaction.update(ticketCounterDoc, { current: ticketNumberValue });
            }
        });

        // Format the ticket number as PO-1, PO-2, etc.
        const ticketNumber = `PO-${ticketNumberValue}`;

        const now = new Date();
        const timestamp = now.toISOString(); // e.g., "2024-05-30T12:34:56.789Z"
        const formattedDate = now.toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric'
        });
        const formattedTime = now.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });

        // Collect educational background data directly from the table
        const educationTable = document.querySelector('.form-section:nth-of-type(4) table');
        const educationRows = educationTable ? educationTable.querySelectorAll('tbody tr') : [];
        const educationData = [];
        for (let i = 0; i < educationRows.length; i++) {
            const row = educationRows[i];
            const inputs = row.querySelectorAll('input');
            if (inputs.length >= 4) {
                educationData.push({
                    name: inputs[0].value || 'N/A',
                    level: inputs[1].value || 'N/A',
                    year: inputs[2].value || 'N/A',
                    degree: inputs[3].value || 'N/A'
                });
            }
        }

        // Collect working experience data directly from the table
        const experienceTable = document.querySelector('.form-section:nth-of-type(7) table');
        const experienceRows = experienceTable ? experienceTable.querySelectorAll('tbody tr') : [];
        const experienceData = [];
        for (let i = 0; i < experienceRows.length; i++) {
            const row = experienceRows[i];
            const inputs = row.querySelectorAll('input');
            if (inputs.length >= 5) {
                experienceData.push({
                    company: inputs[0].value || 'N/A',
                    position: inputs[1].value || 'N/A',
                    dates: inputs[2].value || 'N/A',
                    salary: inputs[3].value || 'N/A',
                    yearsOfExperience: inputs[4].value || 'N/A'
                });
            }
        }

        // Collect training/seminars data directly from the table
        const trainingTable = document.querySelector('.form-section:nth-of-type(8) table');
        const trainingRows = trainingTable ? trainingTable.querySelectorAll('tbody tr') : [];
        const trainingData = [];
        for (let i = 0; i < trainingRows.length; i++) {
            const row = trainingRows[i];
            const inputs = row.querySelectorAll('input');
            if (inputs.length >= 4) {
                trainingData.push({
                    title: inputs[0].value || 'N/A',
                    venue: inputs[1].value || 'N/A',
                    dates: inputs[2].value || 'N/A',
                    hours: inputs[3].value || 'N/A'
                });
            }
        }

        // Collect licenses/examinations data directly from the table
        const licenseTable = document.querySelector('.form-section:nth-of-type(9) table');
        const licenseRows = licenseTable ? licenseTable.querySelectorAll('tbody tr') : [];
        const licenseData = [];
        for (let i = 0; i < licenseRows.length; i++) {
            const row = licenseRows[i];
            const inputs = row.querySelectorAll('input');
            if (inputs.length >= 4) {
                licenseData.push({
                    title: inputs[0].value || 'N/A',
                    year: inputs[1].value || 'N/A',
                    rating: inputs[2].value || 'N/A',
                    expiry: inputs[3].value || 'N/A'
                });
            }
        }

        // Collect competency assessment data directly from the table
        const competencyTable = document.querySelector('.form-section:nth-of-type(10) table');
        const competencyRows = competencyTable ? competencyTable.querySelectorAll('tbody tr') : [];
        const competencyData = [];
        for (let i = 0; i < competencyRows.length; i++) {
            const row = competencyRows[i];
            const inputs = row.querySelectorAll('input');
            if (inputs.length >= 6) {
                competencyData.push({
                    sector: inputs[0].value || 'N/A',
                    tradeArea: inputs[1].value || 'N/A',
                    occupation: inputs[2].value || 'N/A',
                    classificationLevel: inputs[3].value || 'N/A',
                    competency: inputs[4].value || 'N/A',
                    specialization: inputs[5].value || 'N/A'
                });
            }
        }

        // Create application data object (no pdfDocument)
        const applicationData = {
            ticketNumber: ticketNumber,
            timestamp: `${formattedDate} ${formattedTime}`,
            tesdaInfo: {
                nmisCode: getValue('nmis-code'),
                nmisDate: getValue('nmis-date')
            },
            manpowerProfile: {
                lastName: getValue('last_name'),
                firstName: getValue('first_name'),
                middleInitial: getValue('middle_initial'),
                extension: getValue('extension'),
                mailingAddress: getValue('address'),
                city: getValue('city'),
                province: getValue('province'),
                region: getValue('region'),
                zipCode: getValue('zip-code'),
                poBox: getValue('po-box'),
                sex: getValue('sex'),
                civilStatus: getValue('civil-status'),
                contact: getValue('contact'),
                telephone: getValue('telephone'),
                email: getValue('email'),
                fax: getValue('fax'),
                employmentType: getValue('employment-type'),
                employmentStatus: getValue('employment-status')
            },
            personalInfo: {
                birthdate: getValue('birthdate'),
                birthplace: getValue('birthplace'),
                citizenship: getValue('citizenship'),
                religion: getValue('religion'),
                height: getValue('height'),
                weight: getValue('weight'),
                bloodType: getValue('blood-type'),
                sssNo: getValue('sss'),
                gsisNo: getValue('gsis'),
                tinNo: getValue('tin'),
                distinguishingMarks: getValue('distinguishing-marks')
            },
            educationalBackground: {
                schools: educationData
            },
            courseInfo: {
                courseTitle: getValue('course-title'),
                trainingDuration: getValue('training-duration'),
                scheduleFrom: getValue('schedule-from'),
                scheduleTo: getValue('schedule-to'),
                aptitudeExamDate: getValue('aptitude-exam-date'),
                aptitudeExamTime: getValue('aptitude-exam-time')
            },
            competencyAssessment: {
                applicationDate: getValue('application-date'),
                sectorComponent: getValue('sector-component'),
                tradeArea: getValue('trade-area'),
                occupation: getValue('occupation'),
                classification: getValue('classification'),
                competency: getValue('competency'),
                trainingProgram: getValue('training-program'),
                programSector: getValue('program-sector'),
                clientType: getValue('client-type')
            },
            workingExperience: {
                totalYears: getValue('years_of_experience'),
                trainingHours: getValue('training_hours'),
                trainingInstitution: getValue('training_institution'),
                typeTrainingInstitution: getValue('type_training_institution'),
                educationalAttainment: getValue('educational_attainment'),
                experiences: experienceData
            },
            trainingSeminars: trainingData,
            licenses: licenseData,
            competencyAssessmentPassed: competencyData,
            familyBackground: {
                spouse: {
                    name: getValue('spouse-name'),
                    education: getValue('spouse-education'),
                    occupation: getValue('spouse-occupation'),
                    income: getValue('spouse-income')
                },
                father: {
                    name: getValue('father-name'),
                    education: getValue('father-education'),
                    occupation: getValue('father-occupation'),
                    income: getValue('father-income')
                },
                mother: {
                    name: getValue('mother-name'),
                    education: getValue('mother-education'),
                    occupation: getValue('mother-occupation'),
                    income: getValue('mother-income')
                },
                guardian: {
                    name: getValue('guardian-name'),
                    education: getValue('guardian-education'),
                    occupation: getValue('guardian-occupation'),
                    income: getValue('guardian-income')
                },
                dependents: getValue('dependents'),
                dependentAge: getValue('dependent-age')
            },
            nttcApplication: {
                sector: getValue('sector'),
                qualification: getValue('qualification'),
                nttcstatus: getValue('nttcstatus'),
                ncCertNumber: getValue('nc_cert_number'),
                ncDateIssuance: getValue('nc_date_issuance'),
                ncValidity: getValue('nc_validity'),
                tmCertNumber: getValue('tm_cert_number_actual'),
                tmDateIssuance: getValue('tm_date_issuance'),
                tmValidity: getValue('tm_validity'),
                assessor1: getValue('assessor1'),
                assessor2: getValue('assessor2'),
                assessor3: getValue('assessor3')
            }
        };

        // Store the application data in localStorage
        localStorage.setItem(`applicationData_${ticketNumber}`, JSON.stringify(applicationData));
        localStorage.setItem('lastTicketNumber', ticketNumber);

        // Hide loading modal
        document.getElementById('loadingModal').style.display = 'none';

        // Redirect to preview1.html with the ticket number as a URL parameter
        window.location.href = `../admindash/preview1.html?ticketNumber=${encodeURIComponent(ticketNumber)}`;
    } catch (error) {
        console.error('Error sending application:', error);
        document.getElementById('loadingModal').style.display = 'none';
        alert(`Error sending application: ${error.message}`);
    }
}

async function saveChangesToFirebase() {
    try {
        // Show loading indicator
        const editButton = document.getElementById('editToggle');
        const originalText = editButton.textContent;
        editButton.textContent = 'Saving...';
        editButton.disabled = true;

        // Helper function to safely get element value
        const getValue = (id) => {
            const element = document.getElementById(id);
            return element ? element.value : '';
        };

        // Get the ticket number from localStorage or URL
        const ticketNumber = localStorage.getItem('lastTicketNumber') || 
                           new URLSearchParams(window.location.search).get('ticketNumber');

        if (!ticketNumber) {
            throw new Error('No ticket number found. Cannot update application.');
        }

        // Initialize Firebase if not already done
        if (!window.firebaseApp) {
            const firebaseConfig = {
                apiKey: "AIzaSyBknxUstLA8F4YkkNT9rVCoEgTzJBSu24A",
                authDomain: "r7nttconaf.firebaseapp.com",
                projectId: "r7nttconaf",
                storageBucket: "r7nttconaf.firebasestorage.app",
                messagingSenderId: "521822609098",
                appId: "1:521822609098:web:e8ee10f63098924bb35e33",
                measurementId: "G-0VPXC641LT"
            };
            window.firebaseApp = initializeApp(firebaseConfig);
        }

        if (!window.firestore) {
            window.firestore = getFirestore(window.firebaseApp);
        }

        // Collect all form data
        const updatedData = {
            // 1. TESDA Section
            tesdaInfo: {
                nmisCode: getValue('nmis-code'),
                nmisDate: getValue('nmis-date')
            },

            // 2. Manpower Profile
            manpowerProfile: {
                lastName: getValue('last_name'),
                firstName: getValue('first_name'),
                middleInitial: getValue('middle_initial'),
                extension: getValue('extension'),
                mailingAddress: getValue('address'),
                city: getValue('city'),
                province: getValue('province'),
                region: getValue('region'),
                zipCode: getValue('zip-code'),
                poBox: getValue('po-box'),
                sex: getValue('sex'),
                civilStatus: getValue('civil-status'),
                contact: getValue('contact'),
                telephone: getValue('telephone'),
                email: getValue('email'),
                fax: getValue('fax'),
                employmentType: getValue('employment-type'),
                employmentStatus: getValue('employment-status')
            },

            // 3. Personal Information
            personalInfo: {
                birthdate: getValue('birthdate'),
                birthplace: getValue('birthplace'),
                citizenship: getValue('citizenship'),
                religion: getValue('religion'),
                height: getValue('height'),
                weight: getValue('weight'),
                bloodType: getValue('blood-type'),
                sssNo: getValue('sss'),
                gsisNo: getValue('gsis'),
                tinNo: getValue('tin'),
                distinguishingMarks: getValue('distinguishing-marks')
            },

            // 4. Educational Background
            educationalBackground: {
                schools: collectEducationalData()
            },

            // 5. Course Title
            courseInfo: {
                courseTitle: getValue('course-title'),
                trainingDuration: getValue('training-duration'),
                scheduleFrom: getValue('schedule-from'),
                scheduleTo: getValue('schedule-to'),
                aptitudeExamDate: getValue('aptitude-exam-date'),
                aptitudeExamTime: getValue('aptitude-exam-time')
            },

            // 6. Competency Assessment
            competencyAssessment: {
                applicationDate: getValue('application-date'),
                sectorComponent: getValue('sector-component'),
                tradeArea: getValue('trade-area'),
                occupation: getValue('occupation'),
                classification: getValue('classification'),
                competency: getValue('competency'),
                trainingProgram: getValue('training-program'),
                programSector: getValue('program-sector'),
                clientType: getValue('client-type')
            },

            // 7. Working Experience
            workingExperience: {
                totalYears: getValue('years_of_experience'),
                trainingHours: getValue('training_hours'),
                trainingInstitution: getValue('training_institution'),
                typeTrainingInstitution: getValue('type_training_institution'),
                educationalAttainment: getValue('educational_attainment'),
                experiences: collectExperienceData()
            },

            // 8. Training/Seminars
            trainingSeminars: collectTrainingData(),

            // 9. Licenses/Examinations
            licenses: collectLicenseData(),

            // 10. Competency Assessment Passed
            competencyAssessmentPassed: collectCompetencyData(),

            // 11. Family Background
            familyBackground: {
                spouse: {
                    name: getValue('spouse-name'),
                    education: getValue('spouse-education'),
                    occupation: getValue('spouse-occupation'),
                    income: getValue('spouse-income')
                },
                father: {
                    name: getValue('father-name'),
                    education: getValue('father-education'),
                    occupation: getValue('father-occupation'),
                    income: getValue('father-income')
                },
                mother: {
                    name: getValue('mother-name'),
                    education: getValue('mother-education'),
                    occupation: getValue('mother-occupation'),
                    income: getValue('mother-income')
                },
                guardian: {
                    name: getValue('guardian-name'),
                    education: getValue('guardian-education'),
                    occupation: getValue('guardian-occupation'),
                    income: getValue('guardian-income')
                },
                dependents: getValue('dependents'),
                dependentAge: getValue('dependent-age')
            },

            // 12. NTTC Application
            nttcApplication: {
                sector: getValue('sector'),
                qualification: getValue('qualification'),
                nttcstatus: getValue('nttcstatus'),
                ncCertNumber: getValue('nc_cert_number'),
                ncDateIssuance: getValue('nc_date_issuance'),
                ncValidity: getValue('nc_validity'),
                tmCertNumber: getValue('tm_cert_number_actual'),
                tmDateIssuance: getValue('tm_date_issuance'),
                tmValidity: getValue('tm_validity'),
                assessor1: getValue('assessor1'),
                assessor2: getValue('assessor2'),
                assessor3: getValue('assessor3')
            },

            // Add update timestamp
            lastUpdated: new Date().toISOString()
        };

        // Find and update the document in Firestore
        const applicationsCollection = collection(window.firestore, 'applications');
        
        // Query to find the document with matching ticket number
        const q = query(applicationsCollection, where("ticketNumber", "==", ticketNumber));
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
            throw new Error('Application not found in database.');
        }

        // Update the first matching document
        const docRef = querySnapshot.docs[0].ref;
        await updateDoc(docRef, updatedData);

        // Show success message
        Swal.fire({
            title: 'Success!',
            text: 'Application updated successfully in Firebase.',
            icon: 'success',
            confirmButtonText: 'OK'
        });

        console.log('Application updated successfully:', ticketNumber);

    } catch (error) {
        console.error('Error updating application:', error);
        
        // Show error message
        Swal.fire({
            title: 'Error!',
            text: error.message || 'Failed to update application. Please try again.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    } finally {
        // Reset button state
        const editButton = document.getElementById('editToggle');
        editButton.disabled = false;
        editButton.textContent = 'Edit Form';
        editButton.style.backgroundColor = '#ff0000';
    }
}

// Helper functions to collect table data
function collectEducationalData() {
    const educationTable = document.querySelector('.form-section:nth-of-type(4) table');
    const educationRows = educationTable ? educationTable.querySelectorAll('tbody tr') : [];
    const educationData = [];
    
    for (let i = 0; i < educationRows.length; i++) {
        const row = educationRows[i];
        const inputs = row.querySelectorAll('input');
        if (inputs.length >= 4) {
            educationData.push({
                name: inputs[0].value || 'N/A',
                level: inputs[1].value || 'N/A',
                year: inputs[2].value || 'N/A',
                degree: inputs[3].value || 'N/A'
            });
        }
    }
    return educationData;
}

function collectExperienceData() {
    const experienceTable = document.querySelector('.form-section:nth-of-type(7) table');
    const experienceRows = experienceTable ? experienceTable.querySelectorAll('tbody tr') : [];
    const experienceData = [];
    
    for (let i = 0; i < experienceRows.length; i++) {
        const row = experienceRows[i];
        const inputs = row.querySelectorAll('input');
        if (inputs.length >= 5) {
            experienceData.push({
                company: inputs[0].value || 'N/A',
                position: inputs[1].value || 'N/A',
                dates: inputs[2].value || 'N/A',
                salary: inputs[3].value || 'N/A',
                yearsOfExperience: inputs[4].value || 'N/A'
            });
        }
    }
    return experienceData;
}

function collectTrainingData() {
    const trainingTable = document.querySelector('.form-section:nth-of-type(8) table');
    const trainingRows = trainingTable ? trainingTable.querySelectorAll('tbody tr') : [];
    const trainingData = [];
    
    for (let i = 0; i < trainingRows.length; i++) {
        const row = trainingRows[i];
        const inputs = row.querySelectorAll('input');
        if (inputs.length >= 4) {
            trainingData.push({
                title: inputs[0].value || 'N/A',
                venue: inputs[1].value || 'N/A',
                dates: inputs[2].value || 'N/A',
                hours: inputs[3].value || 'N/A'
            });
        }
    }
    return trainingData;
}

function collectLicenseData() {
    const licenseTable = document.querySelector('.form-section:nth-of-type(9) table');
    const licenseRows = licenseTable ? licenseTable.querySelectorAll('tbody tr') : [];
    const licenseData = [];
    
    for (let i = 0; i < licenseRows.length; i++) {
        const row = licenseRows[i];
        const inputs = row.querySelectorAll('input');
        if (inputs.length >= 4) {
            licenseData.push({
                title: inputs[0].value || 'N/A',
                year: inputs[1].value || 'N/A',
                rating: inputs[2].value || 'N/A',
                expiry: inputs[3].value || 'N/A'
            });
        }
    }
    return licenseData;
}

function collectCompetencyData() {
    const competencyTable = document.querySelector('.form-section:nth-of-type(10) table');
    const competencyRows = competencyTable ? competencyTable.querySelectorAll('tbody tr') : [];
    const competencyData = [];
    
    for (let i = 0; i < competencyRows.length; i++) {
        const row = competencyRows[i];
        const inputs = row.querySelectorAll('input');
        if (inputs.length >= 6) {
            competencyData.push({
                sector: inputs[0].value || 'N/A',
                tradeArea: inputs[1].value || 'N/A',
                occupation: inputs[2].value || 'N/A',
                classificationLevel: inputs[3].value || 'N/A',
                competency: inputs[4].value || 'N/A',
                specialization: inputs[5].value || 'N/A'
            });
        }
    }
    return competencyData;
}

async function loadDataFromFirebase(ticketNumber) {
    try {
        // Initialize Firebase if not already done
        if (!window.firebaseApp) {
            const firebaseConfig = {
                apiKey: "AIzaSyBknxUstLA8F4YkkNT9rVCoEgTzJBSu24A",
                authDomain: "r7nttconaf.firebaseapp.com",
                projectId: "r7nttconaf",
                storageBucket: "r7nttconaf.firebasestorage.app",
                messagingSenderId: "521822609098",
                appId: "1:521822609098:web:e8ee10f63098924bb35e33",
                measurementId: "G-0VPXC641LT"
            };
            window.firebaseApp = initializeApp(firebaseConfig);
        }

        if (!window.firestore) {
            window.firestore = getFirestore(window.firebaseApp);
        }

        // Query Firestore for the application data
        const applicationsCollection = collection(window.firestore, 'applications');
        const q = query(applicationsCollection, where("ticketNumber", "==", ticketNumber));
        console.log('Searching for ticket number:', ticketNumber);
        const querySnapshot = await getDocs(q);
        
        console.log('Query result:', querySnapshot.size, 'documents found');
        
        if (querySnapshot.empty) {
            throw new Error('Application not found in database.');
        }

        const applicationData = querySnapshot.docs[0].data();
        console.log('Loaded application data from Firebase:', applicationData);
        console.log('Working experience data:', applicationData.workingExperience);

        // Populate form with Firebase data
        populateFormFromFirebase(applicationData);

    } catch (error) {
        console.error('Error loading data from Firebase:', error);
        throw error;
    }
}

function populateFormFromFirebase(data) {
    // Helper function to safely set element value
    const setValue = (id, value) => {
        const element = document.getElementById(id);
        if (element && value !== undefined) {
            element.value = value;
            // For select elements, ensure they're properly enabled/disabled
            if (element.tagName === 'SELECT') {
                element.disabled = false; // Temporarily enable to set value
                element.value = value;
                element.disabled = true; // Disable again for readonly mode
            }
        }
    };

    // 1. TESDA Section
    if (data.tesdaInfo) {
        setValue('nmis-code', data.tesdaInfo.nmisCode);
        setValue('nmis-date', data.tesdaInfo.nmisDate);
    }

    // 2. Manpower Profile
    if (data.manpowerProfile) {
        setValue('last_name', data.manpowerProfile.lastName);
        setValue('first_name', data.manpowerProfile.firstName);
        setValue('middle_initial', data.manpowerProfile.middleInitial);
        setValue('extension', data.manpowerProfile.extension);
        setValue('address', data.manpowerProfile.mailingAddress);
        setValue('city', data.manpowerProfile.city);
        setValue('province', data.manpowerProfile.province);
        setValue('region', data.manpowerProfile.region);
        setValue('zip-code', data.manpowerProfile.zipCode);
        setValue('po-box', data.manpowerProfile.poBox);
        setValue('sex', data.manpowerProfile.sex);
        setValue('civil-status', data.manpowerProfile.civilStatus);
        setValue('contact', data.manpowerProfile.contact);
        setValue('telephone', data.manpowerProfile.telephone);
        setValue('email', data.manpowerProfile.email);
        setValue('fax', data.manpowerProfile.fax);
        setValue('employment-type', data.manpowerProfile.employmentType);
        setValue('employment-status', data.manpowerProfile.employmentStatus);
    }

    // 3. Personal Information
    if (data.personalInfo) {
        setValue('birthdate', data.personalInfo.birthdate);
        setValue('birthplace', data.personalInfo.birthplace);
        setValue('citizenship', data.personalInfo.citizenship);
        setValue('religion', data.personalInfo.religion);
        setValue('height', data.personalInfo.height);
        setValue('weight', data.personalInfo.weight);
        setValue('blood-type', data.personalInfo.bloodType);
        setValue('sss', data.personalInfo.sssNo);
        setValue('gsis', data.personalInfo.gsisNo);
        setValue('tin', data.personalInfo.tinNo);
        setValue('distinguishing-marks', data.personalInfo.distinguishingMarks);
    }

    // 4. Educational Background
    if (data.educationalBackground && data.educationalBackground.schools) {
        const schoolInputs = document.querySelectorAll('input[name="school[]"]');
        const educLevelInputs = document.querySelectorAll('input[name="educational-level[]"]');
        const schoolYearInputs = document.querySelectorAll('input[name="school-year[]"]');
        const degreeInputs = document.querySelectorAll('input[name="degree[]"]');

        data.educationalBackground.schools.forEach((school, index) => {
            if (schoolInputs[index]) schoolInputs[index].value = school.name || 'N/A';
            if (educLevelInputs[index]) educLevelInputs[index].value = school.level || 'N/A';
            if (schoolYearInputs[index]) schoolYearInputs[index].value = school.year || 'N/A';
            if (degreeInputs[index]) degreeInputs[index].value = school.degree || 'N/A';
        });
    }

    // 5. Course Title
    if (data.courseInfo) {
        setValue('course-title', data.courseInfo.courseTitle);
        setValue('training-duration', data.courseInfo.trainingDuration);
        setValue('schedule-from', data.courseInfo.scheduleFrom);
        setValue('schedule-to', data.courseInfo.scheduleTo);
        setValue('aptitude-exam-date', data.courseInfo.aptitudeExamDate);
        setValue('aptitude-exam-time', data.courseInfo.aptitudeExamTime);
    }

    // 6. Competency Assessment
    if (data.competencyAssessment) {
        setValue('application-date', data.competencyAssessment.applicationDate);
        setValue('sector-component', data.competencyAssessment.sectorComponent);
        setValue('trade-area', data.competencyAssessment.tradeArea);
        setValue('occupation', data.competencyAssessment.occupation);
        setValue('classification', data.competencyAssessment.classification);
        setValue('competency', data.competencyAssessment.competency);
        setValue('training-program', data.competencyAssessment.trainingProgram);
        setValue('program-sector', data.competencyAssessment.programSector);
        setValue('client-type', data.competencyAssessment.clientType);
    }

    // 7. Working Experience
    if (data.workingExperience) {
        setValue('years_of_experience', data.workingExperience.totalYears || '');
        setValue('training_hours', data.workingExperience.trainingHours || '');
        setValue('training_institution', data.workingExperience.trainingInstitution || '');
        setValue('type_training_institution', data.workingExperience.typeTrainingInstitution || 'private');
        setValue('educational_attainment', data.workingExperience.educationalAttainment || 'college');
        // After assigning values, disable selects
        const typeTrainingEl = document.getElementById('type_training_institution');
        if (typeTrainingEl) typeTrainingEl.disabled = true;
        const educationalEl = document.getElementById('educational_attainment');
        if (educationalEl) educationalEl.disabled = true;
        // Populate experience table
        if (Array.isArray(data.workingExperience.experiences)) {
            const companyInputs = document.querySelectorAll('input[name="company[]"]');
            const positionInputs = document.querySelectorAll('input[name="position[]"]');
            const datesInputs = document.querySelectorAll('input[name="dates[]"]');
            const salaryInputs = document.querySelectorAll('input[name="salary[]"]');
            const expYearsInputs = document.querySelectorAll('input[name="years-of-experience[]"]');
            data.workingExperience.experiences.forEach((exp, index) => {
                if (companyInputs[index]) companyInputs[index].value = exp.company || '';
                if (positionInputs[index]) positionInputs[index].value = exp.position || '';
                if (datesInputs[index]) datesInputs[index].value = exp.dates || '';
                if (salaryInputs[index]) salaryInputs[index].value = exp.salary || '';
                if (expYearsInputs[index]) expYearsInputs[index].value = exp.yearsOfExperience || '';
            });
        }
    }

    // 8. Training/Seminars
    if (data.trainingSeminars) {
        const trainingTitleInputs = document.querySelectorAll('input[name="training-title[]"]');
        const trainingVenueInputs = document.querySelectorAll('input[name="training-venue[]"]');
        const trainingDatesInputs = document.querySelectorAll('input[name="training-dates[]"]');
        const trainingHoursInputs = document.querySelectorAll('input[name="training-hours[]"]');

        data.trainingSeminars.forEach((training, index) => {
            if (trainingTitleInputs[index]) trainingTitleInputs[index].value = training.title || 'N/A';
            if (trainingVenueInputs[index]) trainingVenueInputs[index].value = training.venue || 'N/A';
            if (trainingDatesInputs[index]) trainingDatesInputs[index].value = training.dates || 'N/A';
            if (trainingHoursInputs[index]) trainingHoursInputs[index].value = training.hours || 'N/A';
        });
    }

    // 9. Licenses/Examinations
    if (data.licenses) {
        const licenseTitleInputs = document.querySelectorAll('input[name="license-title[]"]');
        const licenseYearInputs = document.querySelectorAll('input[name="license-year[]"]');
        const licenseRatingInputs = document.querySelectorAll('input[name="license-rating[]"]');
        const licenseExpiryInputs = document.querySelectorAll('input[name="license-expiry[]"]');

        data.licenses.forEach((license, index) => {
            if (licenseTitleInputs[index]) licenseTitleInputs[index].value = license.title || 'N/A';
            if (licenseYearInputs[index]) licenseYearInputs[index].value = license.year || 'N/A';
            if (licenseRatingInputs[index]) licenseRatingInputs[index].value = license.rating || 'N/A';
            if (licenseExpiryInputs[index]) licenseExpiryInputs[index].value = license.expiry || 'N/A';
        });
    }

    // 10. Competency Assessment Passed
    if (data.competencyAssessmentPassed) {
        const compSectorInputs = document.querySelectorAll('input[name="competency-sector[]"]');
        const compTradeInputs = document.querySelectorAll('input[name="competency-trade[]"]');
        const compOccupationInputs = document.querySelectorAll('input[name="competency-occupation[]"]');
        const classificationLevelInputs = document.querySelectorAll('input[name="classification-level[]"]');
        const competencyInputs = document.querySelectorAll('input[name="competency[]"]');
        const specializationInputs = document.querySelectorAll('input[name="specialization-description[]"]');

        data.competencyAssessmentPassed.forEach((comp, index) => {
            if (compSectorInputs[index]) compSectorInputs[index].value = comp.sector || 'N/A';
            if (compTradeInputs[index]) compTradeInputs[index].value = comp.tradeArea || 'N/A';
            if (compOccupationInputs[index]) compOccupationInputs[index].value = comp.occupation || 'N/A';
            if (classificationLevelInputs[index]) classificationLevelInputs[index].value = comp.classificationLevel || 'N/A';
            if (competencyInputs[index]) competencyInputs[index].value = comp.competency || 'N/A';
            if (specializationInputs[index]) specializationInputs[index].value = comp.specialization || 'N/A';
        });
    }

    // 11. Family Background
    if (data.familyBackground) {
        setValue('spouse-name', data.familyBackground.spouse?.name);
        setValue('spouse-education', data.familyBackground.spouse?.education);
        setValue('spouse-occupation', data.familyBackground.spouse?.occupation);
        setValue('spouse-income', data.familyBackground.spouse?.income);
        setValue('father-name', data.familyBackground.father?.name);
        setValue('father-education', data.familyBackground.father?.education);
        setValue('father-occupation', data.familyBackground.father?.occupation);
        setValue('father-income', data.familyBackground.father?.income);
        setValue('mother-name', data.familyBackground.mother?.name);
        setValue('mother-education', data.familyBackground.mother?.education);
        setValue('mother-occupation', data.familyBackground.mother?.occupation);
        setValue('mother-income', data.familyBackground.mother?.income);
        setValue('guardian-name', data.familyBackground.guardian?.name);
        setValue('guardian-education', data.familyBackground.guardian?.education);
        setValue('guardian-occupation', data.familyBackground.guardian?.occupation);
        setValue('guardian-income', data.familyBackground.guardian?.income);
        setValue('dependents', data.familyBackground.dependents);
        setValue('dependent-age', data.familyBackground.dependentAge);
    }

    // 12. NTTC Application
    if (data.nttcApplication) {
        setValue('sector', data.nttcApplication.sector);
        setValue('qualification', data.nttcApplication.qualification);
        setValue('nttcstatus', data.nttcApplication.nttcstatus);
        setValue('nc_cert_number', data.nttcApplication.ncCertNumber);
        setValue('nc_date_issuance', data.nttcApplication.ncDateIssuance);
        setValue('nc_validity', data.nttcApplication.ncValidity);
        setValue('tm_cert_number_actual', data.nttcApplication.tmCertNumber);
        setValue('tm_date_issuance', data.nttcApplication.tmDateIssuance);
        setValue('tm_validity', data.nttcApplication.tmValidity);
        setValue('assessor1', data.nttcApplication.assessor1);
        setValue('assessor2', data.nttcApplication.assessor2);
        setValue('assessor3', data.nttcApplication.assessor3);
    }

            console.log('Form populated from Firebase data successfully');
        
        // Debug: Check if working experience fields exist
        const yearsOfExpElement = document.getElementById('years_of_experience');
        const trainingHoursElement = document.getElementById('training_hours');
        const trainingInstitutionElement = document.getElementById('training_institution');
        const typeTrainingInstitutionElement = document.getElementById('type_training_institution');
        const educationalAttainmentElement = document.getElementById('educational_attainment');
        
        console.log('Working experience elements found:', {
            yearsOfExp: !!yearsOfExpElement,
            trainingHours: !!trainingHoursElement,
            trainingInstitution: !!trainingInstitutionElement,
            typeTrainingInstitution: !!typeTrainingInstitutionElement,
            educationalAttainment: !!educationalAttainmentElement
        });
        
        // Test function for debugging
        window.testWorkingExperienceFields = function() {
            console.log('Testing working experience fields...');
            const testData = {
                workingExperience: {
                    totalYears: '5',
                    trainingHours: '120',
                    trainingInstitution: 'Test Institution',
                    typeTrainingInstitution: 'private',
                    educationalAttainment: 'college'
                }
            };
            populateFormFromFirebase(testData);
        };
        
        // Test function for URL parameters
        window.testURLParameters = function() {
            console.log('Testing URL parameters...');
            const testParams = new URLSearchParams();
            testParams.set('years_of_experience', '5');
            testParams.set('training_hours', '120');
            testParams.set('training_institution', 'Test Institution');
            testParams.set('type_training_institution', 'private');
            testParams.set('educational_attainment', 'college');
            populateFormFromParams(testParams);
        };
        
        // Function to check current form values
        window.checkFormValues = function() {
            console.log('Current form values:');
            console.log('years_of_experience:', document.getElementById('years_of_experience')?.value);
            console.log('training_hours:', document.getElementById('training_hours')?.value);
            console.log('training_institution:', document.getElementById('training_institution')?.value);
            console.log('type_training_institution:', document.getElementById('type_training_institution')?.value);
            console.log('educational_attainment:', document.getElementById('educational_attainment')?.value);
        };
        
        // Function to test Firebase connection
        window.testFirebaseConnection = async function() {
            try {
                console.log('Testing Firebase connection...');
                const ticketNumber = localStorage.getItem('lastTicketNumber');
                console.log('Last ticket number:', ticketNumber);
                
                if (ticketNumber) {
                    await loadDataFromFirebase(ticketNumber);
                } else {
                    console.log('No ticket number found in localStorage');
                }
            } catch (error) {
                console.error('Firebase connection test failed:', error);
            }
        };
}

function closeTicketModal() {
    const ticketModal = document.getElementById('ticketModal');
    ticketModal.classList.remove('show');
    setTimeout(() => {
        ticketModal.style.display = 'none';
    }, 300);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const ticketModal = document.getElementById('ticketModal');
    if (event.target === ticketModal) {
        closeTicketModal();
    }
}

    </script>

    <!-- Add this function to handle closing the success modal -->
    <script>
        function closeSuccessModal() {
            const successModal = document.getElementById('successModal');
            successModal.classList.remove('show');
            setTimeout(() => {
                successModal.style.display = 'none';
            }, 300);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const successModal = document.getElementById('successModal');
            if (event.target === successModal) {
                closeSuccessModal();
            }
        }
    </script>

    <script>
    // ... existing code ...
    // --- PATCH: Ensure working experience fields are populated after DOM is loaded ---
    document.addEventListener('DOMContentLoaded', function() {
        // Helper to set value and log if not found
        function setFieldValue(id, value) {
            const el = document.getElementById(id);
            if (el) {
                el.value = value || '';
                // For select, ensure correct option is selected
                if (el.tagName === 'SELECT' && value) {
                    el.disabled = false;
                    el.value = value;
                    el.disabled = true;
                }
                console.log(`Set #${id} to`, value);
            } else {
                console.warn(`Element #${id} not found in DOM`);
            }
        }

        // Patch Firestore population logic
        const origPopulateFormFromFirebase = window.populateFormFromFirebase;
        window.populateFormFromFirebase = function(data) {
            // Call original
            if (origPopulateFormFromFirebase) origPopulateFormFromFirebase(data);
            // Patch: Working Experience fields
            if (data && data.workingExperience) {
                setFieldValue('years_of_experience', data.workingExperience.totalYears);
                setFieldValue('training_hours', data.workingExperience.trainingHours);
                setFieldValue('training_institution', data.workingExperience.trainingInstitution);
                setFieldValue('type_training_institution', data.workingExperience.typeTrainingInstitution);
                setFieldValue('educational_attainment', data.workingExperience.educationalAttainment);
            } else {
                console.warn('No workingExperience data found in Firestore document');
            }
        };

        // If data is already loaded (e.g. from Firestore), re-populate
        if (window.lastLoadedFirebaseData) {
            window.populateFormFromFirebase(window.lastLoadedFirebaseData);
        }
    });
    // ... existing code ...
    </script>
</body>
</html>